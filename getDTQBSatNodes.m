% getDTQBSatNodes.m
% This function calculates the values of the first derivative of the
% Trigonometric Quintic B-spline (TQB) basis functions at a given set of nodes.
% The TQB basis functions are defined over a uniform grid.

% Inputs:
% x: A row vector of spatial nodes (grid points) where the TQB basis
%    derivative functions are to be evaluated.


% Output:
% DT: An (N) x (M+4) matrix where N is the number of grid points
%    and M+4 is the number of TQB basis functions.
%    DT(i, j) = Value of the first derivative of the j-th TQB basis function
%               at the i-th grid point.

function DT = getDTQBSatNodes(x)
    % Initialize the matrices for the basis functions and their derivatives
    d1 = abs(x(2)-x(1)); d2 = abs(x(end)-x(end-1));
    N = length(x);
    DT = zeros(N,N+4);
    
    % Update x with ghost points   
    x = [x(1)-6*d1 x(1)-5*d1 x(1)-4*d1 x(1)-3*d1 x(1)-2*d1 x(1)-d1 x x(end)+d2 x(end)+2*d2 x(end)+3*d2 x(end)+4*d2 x(end)+5*d2 x(end)+6*d2]; % x with ghost points

    % The local support of a quintic B-spline is 6 intervals.
    % This loop evaluates the value of the first derivative of each
    % B-spline basis function (j) at the current grid point (xi).
    for j = 7:N+6
        y = x(j);
        
        i = j+2;
        DT(j-6,j+4-6) = (cos(x(i-1)./2 - y./2).*sin(x(i-3)./2 - y./2).^4)./(2.*sin(x(i-3)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i)./2).*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).^4)./(2.*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2)) + (2.*cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).^3.*sin(x(i-1)./2 - y./2))./(sin(x(i-3)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i)./2).*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).^3.*sin(x(i)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i)./2).*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2)) + (cos(x(i)./2 - y./2).*sin(x(i-3)./2 - y./2).^3.*sin(x(i-2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i)./2).*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2)) + (cos(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^3.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^3)./(2.*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2)) + (2.*cos(x(i-2)./2 - y./2).*sin(x(i-2)./2 - y./2).^3.*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-2)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2)) + (3.*cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i)./2).*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2)) + (cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+1)./2 - y./2))./(sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2))./(sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2)) + (3.*cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i-1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2));

        i = j+1;
        DT(j-6,j+3-6) = - (cos(x(i)./2 - y./2).*sin(x(i-3)./2 - y./2).^3.*sin(x(i)./2 - y./2))./(sin(x(i-3)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i)./2 - y./2).*sin(x(i-2)./2 - y./2).^3.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).^3.*sin(x(i)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-1)./2 - y./2).^3.*sin(x(i+3)./2 - y./2))./(sin(x(i-1)./2 - x(i)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+3)./2)) - (3.*cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (3.*cos(x(i-1)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-1)./2 - x(i)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+3)./2)) - (cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).^2)./(sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i)./2 - y./2).*sin(x(i+1)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2)) - (cos(x(i)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2)) - (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2))./(sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (3.*cos(x(i-2)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i+1)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i-1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2)) - (cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+1)./2 - y./2))./(sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2))./(sin(x(i-2)./2 - x(i)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2)) - (cos(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-1)./2 - x(i)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2));

        i = j;
        DT(j-6,j+2-6) = (cos(x(i-3)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i+1)./2 - y./2).^3)./(sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-3)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).^3)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i+2)./2 - y./2).^3)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+3)./2 - y./2).^3)./(sin(x(i-2)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+3)./2)) + (3.*cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+1)./2).*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2)) + (3.*cos(x(i+3)./2 - y./2).*sin(x(i)./2 - y./2).^2.*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+3)./2)) + (cos(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i+1)./2 - y./2).^2.*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-2)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+1)./2)) + (3.*cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i-1)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+2)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i-1)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-1)./2 - y./2).^2.*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i-1)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+1)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+2)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+1)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2)) + (cos(x(i+2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i)./2 - x(i+2)./2)) + (cos(x(i+3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+1)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2));

        i = j-1;
        DT(j-6,j+1-6) = - (cos(x(i-3)./2 - y./2).*sin(x(i+2)./2 - y./2).^4)./(2.*sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2).^4)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+3)./2)) - (2.*cos(x(i+2)./2 - y./2).*sin(x(i-3)./2 - y./2).*sin(x(i+2)./2 - y./2).^3)./(sin(x(i-3)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i-2)./2 - y./2).*sin(x(i+2)./2 - y./2).^3.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+2)./2 - y./2).^3)./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2).^3)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+3)./2 - y./2).^3)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (2.*cos(x(i+3)./2 - y./2).*sin(x(i+1)./2 - y./2).*sin(x(i+3)./2 - y./2).^3)./(sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+3)./2)) - (cos(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2.*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (3.*cos(x(i+2)./2 - y./2).*sin(x(i-2)./2 - y./2).*sin(x(i+2)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(2.*sin(x(i-2)./2 - x(i+2)./2).*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i+2)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (cos(x(i+3)./2 - y./2).*sin(x(i-1)./2 - y./2).*sin(x(i+2)./2 - y./2).^2.*sin(x(i+3)./2 - y./2))./(sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+2)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i+1)./2 - x(i+2)./2)) - (3.*cos(x(i+3)./2 - y./2).*sin(x(i)./2 - y./2).*sin(x(i+2)./2 - y./2).*sin(x(i+3)./2 - y./2).^2)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+2)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+2)./2));
                
        i = j-2;
        DT(j-6,j-6) = (5.*cos(x(i+3)./2 - y./2).*sin(x(i+3)./2 - y./2).^4)./(2.*sin(x(i-2)./2 - x(i+3)./2).*sin(x(i-1)./2 - x(i+3)./2).*sin(x(i)./2 - x(i+3)./2).*sin(x(i+1)./2 - x(i+3)./2).*sin(x(i+2)./2 - x(i+3)./2));
    end

end